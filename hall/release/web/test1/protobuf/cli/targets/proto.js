"use strict";function underScore(e){return e.substring(0,1)+e.substring(1).replace(/([A-Z])(?=[a-z]|$)/g,function(e,n){return"_"+n.toLowerCase()})}function proto_target(e,n,t){if(n)switch(n.syntax){case void 0:case"proto3":case"3":syntax=3;break;case"proto2":case"2":syntax=2;break;default:return t(Error("invalid syntax: "+n.syntax))}indent=0,first=!1;try{return buildRoot(e),t(null,out.join("\n"))}catch(e){return t(e)}finally{out=[],syntax=3}}function push(e){if(""===e)out.push("");else{for(var n="",t=0;t<indent;++t)n+="    ";out.push(n+e)}}function escape(e){return e.replace(/[\\"']/g,"\\$&").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\u0000/g,"\\0")}function value(e){switch(typeof e){case"boolean":return e?"true":"false";case"number":return e.toString();default:return'"'+escape(String(e))+'"'}}function buildRoot(e){e.resolveAll();var n=[],t=e,i=!0;do{var r=t.nestedArray;1===r.length&&r[0]instanceof Namespace&&!(r[0]instanceof Type||r[0]instanceof Service)?(t=r[0])!==e&&n.push(t.name):i=!1}while(i);out.push('syntax = "proto'+syntax+'";'),n.length&&out.push("","package "+n.join(".")+";"),buildOptions(t),t.nestedArray.forEach(build)}function build(e){e instanceof Enum?buildEnum(e):e instanceof Type?buildType(e):e instanceof Field?buildField(e):e instanceof OneOf?buildOneOf(e):e instanceof Service?buildService(e):e instanceof Method?buildMethod(e):buildNamespace(e)}function buildNamespace(e){push(""),push("message "+e.name+" {"),++indent,buildOptions(e),consolidateExtends(e.nestedArray).remaining.forEach(build),--indent,push("}")}function buildEnum(e){push(""),push("enum "+e.name+" {"),buildOptions(e),++indent,first=!0,Object.keys(e.values).forEach(function(n){var t=e.values[n];first&&(push(""),first=!1),push(n+" = "+t+";")}),--indent,first=!1,push("}")}function buildRanges(e,n){if(n&&n.length){var t=[];n.forEach(function(e){"string"==typeof e?t.push('"'+escape(e)+'"'):e[0]===e[1]?t.push(e[0]):t.push(e[0]+" to "+(536870911===e[1]?"max":e[1]))}),push(""),push(e+" "+t.join(", "))}}function buildType(e){e.group||(push(""),push("message "+e.name+" {"),++indent,buildOptions(e),e.oneofsArray.forEach(build),first=!0,e.fieldsArray.forEach(build),consolidateExtends(e.nestedArray).remaining.forEach(build),buildRanges("extensions",e.extensions),buildRanges("reserved",e.reserved),--indent,push("}"))}function buildField(e,n){if(!(e.partOf||e.declaringField||void 0!==e.extend&&!n))if(first&&(first=!1,push("")),e.resolvedType&&e.resolvedType.group)buildGroup(e);else{var t=[];e.map?t.push("map<"+e.keyType+", "+e.type+">"):e.repeated?t.push("repeated",e.type):2===syntax||e.parent.group?t.push(e.required?"required":"optional",e.type):t.push(e.type),t.push(underScore(e.name),"=",e.id);var i=buildFieldOptions(e);i&&t.push(i),push(t.join(" ")+";")}}function buildGroup(e){push(e.rule+" group "+e.resolvedType.name+" = "+e.id+" {"),++indent,buildOptions(e.resolvedType),first=!0,e.resolvedType.fieldsArray.forEach(function(e){buildField(e)}),--indent,push("}")}function buildFieldOptions(e){var n;if(!e.options||!(n=Object.keys(e.options)).length)return null;var t=[];return n.forEach(function(n){var i=e.options[n],r=types.packed[e.resolvedType instanceof Enum?"uint32":e.type];switch(n){case"packed":if(i=Boolean(i),void 0===r||3===syntax===i)return;break;case"default":if(e.long&&!util.longNeq(e.defaultValue,types.defaults[e.type])||!e.long&&e.defaultValue===types.defaults[e.type])return;if(e.resolvedType instanceof Enum)break;default:i=value(i)}t.push(n+"="+i)}),t.length?"["+t.join(", ")+"]":null}function consolidateExtends(e){var n={};return e=e.filter(function(e){return!(e instanceof Field&&void 0!==e.extend)||((n[e.extend]||(n[e.extend]=[])).push(e),!1)}),Object.keys(n).forEach(function(e){push(""),push("extend "+e+" {"),++indent,first=!0,n[e].forEach(function(e){buildField(e,!0)}),--indent,push("}")}),{remaining:e}}function buildOneOf(e){push(""),push("oneof "+underScore(e.name)+" {"),++indent,first=!0,e.oneof.forEach(function(n){var t=e.parent.get(n);first&&(first=!1,push(""));var i=buildFieldOptions(t);push(t.type+" "+underScore(t.name)+" = "+t.id+(i?" "+i:"")+";")}),--indent,push("}")}function buildService(e){push("service "+e.name+" {"),++indent,e.methodsArray.forEach(build),consolidateExtends(e.nestedArray).remaining.forEach(build),--indent,push("}")}function buildMethod(e){push(e.type+" "+e.name+" ("+(e.requestStream?"stream ":"")+e.requestType+") returns ("+(e.responseStream?"stream ":"")+e.responseType+");")}function buildOptions(e){e.options&&(first=!0,Object.keys(e.options).forEach(function(n){first&&(first=!1,push(""));var t=e.options[n];push("option "+n+" = "+JSON.stringify(t)+";")}))}module.exports=proto_target,proto_target.private=!0;var protobuf=require("../.."),Namespace=protobuf.Namespace,Enum=protobuf.Enum,Type=protobuf.Type,Field=protobuf.Field,OneOf=protobuf.OneOf,Service=protobuf.Service,Method=protobuf.Method,types=protobuf.types,util=protobuf.util,out=[],indent=0,first=!1,syntax=3;