"use strict";var child_process=require("child_process"),path=require("path"),fs=require("fs"),pkg=require("./package.json"),util=require("./util");util.setup();var minimist=require("minimist"),chalk=require("chalk"),glob=require("glob"),tmp=require("tmp");exports.main=function(e,o){function r(){var e=path.join(__dirname,"."),r=t.name||"null",i='node "'+require.resolve("jsdoc/jsdoc.js")+'" -c "'+path.join(e,"lib","tsd-jsdoc.json")+'" -q "module='+encodeURIComponent(r)+"&comments="+Boolean(t.comments)+'" '+n.map(function(e){return'"'+e+'"'}).join(" "),s=child_process.exec(i,{cwd:process.cwd(),argv0:"node",stdio:"pipe",maxBuffer:1<<24}),c=[];s.stdout.on("data",function(e){c.push(e)}),s.stderr.pipe(process.stderr),s.on("close",function(e){try{a.forEach(fs.unlinkSync)}catch(e){}if(a=[],e){c=c.join("").replace(/\s*JSDoc \d+\.\d+\.\d+ [^$]+/,""),process.stderr.write(c);var r=Error("code "+e);if(o)return o(r);throw r}var n=[];t.global&&n.push("export as namespace "+t.global+";",""),t.main||n.push('import * as $protobuf from "protobufjs";',""),n=n.join("\n")+"\n"+c.join("");try{return t.out?fs.writeFileSync(t.out,n,{encoding:"utf8"}):o||process.stdout.write(n,"utf8"),o?o(null,n):void 0}catch(r){if(o)return o(r);throw r}})}var t=minimist(e,{alias:{name:"n",out:"o",main:"m",global:"g"},string:["name","out","global"],boolean:["comments","main"],default:{comments:!0,main:!1}}),n=t._;if(!n.length)return o?o(Error("usage")):process.stderr.write(["protobuf.js v"+pkg.version+" CLI for TypeScript","",chalk.bold.white("Generates TypeScript definitions from annotated JavaScript files."),"","  -o, --out       Saves to a file instead of writing to stdout.","","  -g, --global    Name of the global object in browser environments, if any.","","  --no-comments   Does not output any JSDoc comments.","",chalk.bold.gray("  Internal flags:"),"","  -n, --name      Wraps everything in a module of the specified name.","","  -m, --main      Whether building the main library without any imports.","","usage: "+chalk.bold.green("pbts")+" [options] file1.js file2.js ..."+chalk.bold.gray("  (or)  ")+"other | "+chalk.bold.green("pbts")+" [options] -",""].join("\n")),1;for(var i=0;i<n.length;)if(glob.hasMagic(n[i])){var s=glob.sync(n[i]);Array.prototype.splice.apply(n,[i,1].concat(s)),i+=s.length}else++i;var a=[];if(1===n.length&&"-"===n[0]){var c=[];process.stdin.on("data",function(e){c.push(e)}),process.stdin.on("end",function(){n[0]=tmp.tmpNameSync()+".js",fs.writeFileSync(n[0],Buffer.concat(c)),a.push(n[0]),r()})}else r()};