function fakeRPC(e){return function(t,n,l){++timesCalled<3?(e.test(e.name+" - should call the rpc impl with",function(e){e.equal(t,MyMethod,"the reflected method"),e.ok(n.length,"a buffer"),e.ok("function"==typeof l,"a callback function"),e.end()}),e.test(e.name+" - should call with a buffer that contains",function(e){e.equal(n[0],3,"ldelim 3"),e.equal(n[1],10,"id 1, wireType 2"),e.equal(n[2],1,"length 1"),e.equal(n[3],47,"the original string"),e.end()}),setTimeout(function(){var e=statusCodes.shift();l(null,MyResponse.encode({status:e}).finish()),200===e&&l(null,null)})):e.equal(n,null,"should signal ended client-side")}}var tape=require("tape"),protobuf=require("..");tape.test("runtime services",function(e){protobuf.load("tests/data/rpc.proto",function(t,n){if(t)return e.fail(t.message);var l=n.lookup("MyService"),a=l.get("MyMethod").resolve(),o=a.resolvedRequestType,u=a.resolvedResponseType,i=[200,400],s=0;l=n.lookup("MyService"),e.plan(2),e.test(e.name+" - closed server-side",function(e){l.create(function(t,n,l){++s<3?(e.test(e.name+" - should call the rpc impl with",function(e){e.equal(t,a,"the reflected method"),e.ok(n.length,"a buffer"),e.ok("function"==typeof l,"a callback function"),e.end()}),e.test(e.name+" - should call with a buffer that contains",function(e){e.equal(n[0],3,"ldelim 3"),e.equal(n[1],10,"id 1, wireType 2"),e.equal(n[2],1,"length 1"),e.equal(n[3],47,"the original string"),e.end()}),setTimeout(function(){var e=i.shift();l(null,u.encode({status:e}).finish()),200===e&&l(null,null)})):e.equal(n,null,"should signal ended client-side")},!0,!1).myMethod(o.create({path:"/"}),function(t,n){if(t)return e.fail(t.message);e.ok(n instanceof u.ctor,"should return an instance of MyResponse"),e.deepEqual(n,{status:200},"should return status 200"),e.end()})}),e.test(e.name+" - closed client-side",function(e){var t=l.create(function(t,n,l){++s<3?(e.test(e.name+" - should call the rpc impl with",function(e){e.equal(t,a,"the reflected method"),e.ok(n.length,"a buffer"),e.ok("function"==typeof l,"a callback function"),e.end()}),e.test(e.name+" - should call with a buffer that contains",function(e){e.equal(n[0],3,"ldelim 3"),e.equal(n[1],10,"id 1, wireType 2"),e.equal(n[2],1,"length 1"),e.equal(n[3],47,"the original string"),e.end()}),setTimeout(function(){var e=i.shift();l(null,u.encode({status:e}).finish()),200===e&&l(null,null)})):e.equal(n,null,"should signal ended client-side")},!0,!1);t.myMethod(o.create({path:"/"}),function(n,l){if(n)return e.fail(n.message);e.ok(l instanceof u.ctor,"should return an instance of MyResponse"),e.deepEqual(l,{status:400},"should return status 400"),t.end();var a=0,i=1;if("undefined"!=typeof Promise){++i;var s=t.myMethod(o.create({path:"/"}));s.catch(function(t){e.ok(t,"should return an error if already ended (Promise)"),++a===i&&e.end()}),e.ok(s instanceof Promise,"should return a promise if callback has been omitted (even if already ended)")}t.myMethod(o.create({path:"/"}),function(t){e.ok(t,"should return an error if already ended"),++a===i&&e.end()})})})})});