"use strict";function Root(e){Namespace.call(this,"",e),this.deferred=[],this.files=[]}function SYNC(){}function tryHandleExtension(e,t){var o=t.parent.lookup(t.extend);if(o){var n=new Field(t.fullName,t.id,t.type,t.rule,void 0,t.options);return n.declaringField=t,t.extensionField=n,o.add(n),!0}return!1}module.exports=Root;var Namespace=require("./namespace");((Root.prototype=Object.create(Namespace.prototype)).constructor=Root).className="Root";var Type,parse,common,Field=require("./field"),Enum=require("./enum"),OneOf=require("./oneof"),util=require("./util");Root.fromJSON=function(e,t){return t||(t=new Root),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},Root.prototype.resolvePath=util.path.resolve,Root.prototype.load=function e(t,o,n){function r(e,t){if(n){var o=n;if(n=null,l)throw e;o(e,t)}}function i(e,t){try{if(util.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),util.isString(t)){parse.filename=e;var n,i=parse(t,a,o),d=0;if(i.imports)for(;d<i.imports.length;++d)(n=a.resolvePath(e,i.imports[d]))&&s(n);if(i.weakImports)for(d=0;d<i.weakImports.length;++d)(n=a.resolvePath(e,i.weakImports[d]))&&s(n,!0)}else a.setOptions(t.options).addJSON(t.nested)}catch(e){r(e)}l||f||r(null,a)}function s(e,t){var o=e.lastIndexOf("google/protobuf/");if(o>-1){var s=e.substring(o);s in common&&(e=s)}if(!(a.files.indexOf(e)>-1))if(a.files.push(e),e in common)l?i(e,common[e]):(++f,setTimeout(function(){--f,i(e,common[e])}));else if(l){var d;try{d=util.fs.readFileSync(e).toString("utf8")}catch(e){return void(t||r(e))}i(e,d)}else++f,util.fetch(e,function(o,s){--f,n&&(o?t?f||r(null,a):r(o):i(e,s))})}"function"==typeof o&&(n=o,o=void 0);var a=this;if(!n)return util.asPromise(e,a,t,o);var l=n===SYNC,f=0;util.isString(t)&&(t=[t]);for(var d,p=0;p<t.length;++p)(d=a.resolvePath("",t[p]))&&s(d);if(l)return a;f||r(null,a)},Root.prototype.loadSync=function(e,t){if(!util.isNode)throw Error("not supported");return this.load(e,t,SYNC)},Root.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(e){return"'extend "+e.extend+"' in "+e.parent.fullName}).join(", "));return Namespace.prototype.resolveAll.call(this)};var exposeRe=/^[A-Z]/;Root.prototype._handleAdd=function(e){if(e instanceof Field)void 0===e.extend||e.extensionField||tryHandleExtension(this,e)||this.deferred.push(e);else if(e instanceof Enum)exposeRe.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof OneOf)){if(e instanceof Type)for(var t=0;t<this.deferred.length;)tryHandleExtension(this,this.deferred[t])?this.deferred.splice(t,1):++t;for(var o=0;o<e.nestedArray.length;++o)this._handleAdd(e._nestedArray[o]);exposeRe.test(e.name)&&(e.parent[e.name]=e)}},Root.prototype._handleRemove=function(e){if(e instanceof Field){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else{var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1)}}else if(e instanceof Enum)exposeRe.test(e.name)&&delete e.parent[e.name];else if(e instanceof Namespace){for(var o=0;o<e.nestedArray.length;++o)this._handleRemove(e._nestedArray[o]);exposeRe.test(e.name)&&delete e.parent[e.name]}},Root._configure=function(e,t,o){Type=e,parse=t,common=o};