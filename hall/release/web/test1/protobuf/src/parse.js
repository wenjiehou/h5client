"use strict";function camelCase(e){return e.substring(0,1)+e.substring(1).replace(camelCaseRe,function(e,t){return t.toUpperCase()})}function parse(e,t,r){function n(e,t,r){var n=parse.filename;return r||(parse.filename=null),Error("illegal "+(t||"token")+" '"+e+"' ("+(n?n+", ":"")+"line "+q.line()+")")}function a(){var e,t=[];do{if('"'!==(e=N())&&"'"!==e)throw n(e);t.push(N()),F(e),e=A()}while('"'===e||"'"===e);return t.join("")}function i(e){var t=N();switch(t){case"'":case'"':return x(t),a();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return function(e,t){var r=1;"-"===e.charAt(0)&&(r=-1,e=e.substring(1));switch(e){case"inf":case"INF":case"Inf":return r*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test(e))return r*parseInt(e,10);if(base16Re.test(e))return r*parseInt(e,16);if(base8Re.test(e))return r*parseInt(e,8);if(numberRe.test(e))return r*parseFloat(e);throw n(e,"number",t)}(t,!0)}catch(r){if(e&&typeRefRe.test(t))return t;throw n(t,"value")}}function o(e,t){var r,n;do{!t||'"'!==(r=A())&&"'"!==r?e.push([n=s(N()),F("to",!0)?s(N()):n]):e.push(a())}while(F(",",!0));F(";")}function s(e,t){switch(e){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!t&&"-"===e.charAt(0))throw n(e,"id");if(base10NegRe.test(e))return parseInt(e,10);if(base16NegRe.test(e))return parseInt(e,16);if(base8NegRe.test(e))return parseInt(e,8);throw n(e,"id")}function f(){if(void 0!==v)throw n("package");if(v=N(),!typeRefRe.test(v))throw n(v,"name");C=C.define(v),F(";")}function u(){var e,t=A();switch(t){case"weak":e=y||(y=[]),N();break;case"public":N();default:e=b||(b=[])}t=a(),F(";"),e.push(t)}function c(){if(F("="),k=a(),!(I="proto3"===k)&&"proto2"!==k)throw n(k,"syntax");F(";")}function p(e,t){switch(t){case"option":return w(e,t),F(";"),!0;case"message":return function(e,t){if(!nameRe.test(t=N()))throw n(t,"type name");var r=new Type(t);l(r,function(e){if(!p(r,e))switch(e){case"map":!function(e){F("<");var t=N();if(void 0===types.mapKey[t])throw n(t,"type");F(",");var r=N();if(!typeRefRe.test(r))throw n(r,"type");F(">");var a=N();if(!nameRe.test(a))throw n(a,"name");F("=");var i=new MapField(E(a),s(N()),t,r);l(i,function(e){if("option"!==e)throw n(e);w(i,e),F(";")},function(){R(i)}),e.add(i)}(r);break;case"required":case"optional":case"repeated":m(r,e);break;case"oneof":!function(e,t){if(!nameRe.test(t=N()))throw n(t,"name");var r=new OneOf(E(t));l(r,function(e){"option"===e?(w(r,e),F(";")):(x(e),m(r,"optional"))}),e.add(r)}(r,e);break;case"extensions":o(r.extensions||(r.extensions=[]));break;case"reserved":o(r.reserved||(r.reserved=[]),!0);break;default:if(!I||!typeRefRe.test(e))throw n(e);x(e),m(r,"optional")}}),e.add(r)}(e,t),!0;case"enum":return function(e,t){if(!nameRe.test(t=N()))throw n(t,"name");var r=new Enum(t);l(r,function(e){"option"===e?(w(r,e),F(";")):function(e,t){if(!nameRe.test(t))throw n(t,"name");F("=");var r=s(N(),!0),a={};l(a,function(e){if("option"!==e)throw n(e);w(a,e),F(";")},function(){R(a)}),e.add(t,r,a.comment)}(r,e)}),e.add(r)}(e,t),!0;case"service":return function(e,t){if(!nameRe.test(t=N()))throw n(t,"service name");var r=new Service(t);l(r,function(e){if(!p(r,e)){if("rpc"!==e)throw n(e);!function(e,t){var r=t;if(!nameRe.test(t=N()))throw n(t,"name");var a,i,o,s,f=t;F("("),F("stream",!0)&&(i=!0);if(!typeRefRe.test(t=N()))throw n(t);a=t,F(")"),F("returns"),F("("),F("stream",!0)&&(s=!0);if(!typeRefRe.test(t=N()))throw n(t);o=t,F(")");var u=new Method(f,r,a,o,i,s);l(u,function(e){if("option"!==e)throw n(e);w(u,e),F(";")}),e.add(u)}(r,e)}}),e.add(r)}(e,t),!0;case"extend":return function(e,t){if(!typeRefRe.test(t=N()))throw n(t,"reference");var r=t;l(null,function(t){switch(t){case"required":case"repeated":case"optional":m(e,t,r);break;default:if(!I||!typeRefRe.test(t))throw n(t);x(t),m(e,"optional",r)}})}(e,t),!0}return!1}function l(e,t,r){var n=q.line();if(e&&(e.comment=z(),e.filename=parse.filename),F("{",!0)){for(var a;"}"!==(a=N());)t(a);F(";",!0)}else r&&r(),F(";"),e&&"string"!=typeof e.comment&&(e.comment=z(n))}function m(e,t,r){var a=N();if("group"!==a){if(!typeRefRe.test(a))throw n(a,"type");var i=N();if(!nameRe.test(i))throw n(i,"name");i=E(i),F("=");var o=new Field(i,s(N()),a,t,r);l(o,function(e){if("option"!==e)throw n(e);w(o,e),F(";")},function(){R(o)}),e.add(o),!I&&o.repeated&&o.setOption("packed",!1,!0)}else!function(e,t){var r=N();if(!nameRe.test(r))throw n(r,"name");var a=util.lcFirst(r);r===a&&(r=util.ucFirst(r));F("=");var i=s(N()),o=new Type(r);o.group=!0;var f=new Field(a,i,r,t);f.filename=parse.filename,l(o,function(e){switch(e){case"option":w(o,e),F(";");break;case"required":case"optional":case"repeated":m(o,e);break;default:throw n(e)}}),e.add(o).add(f)}(e,t)}function w(e,t){var r=F("(",!0);if(!typeRefRe.test(t=N()))throw n(t,"name");var a=t;r&&(F(")"),a="("+a+")",t=A(),fqTypeRefRe.test(t)&&(a+=t,N())),F("="),h(e,a)}function h(e,t){if(F("{",!0))do{if(!nameRe.test(g=N()))throw n(g,"name");"{"===A()?h(e,t+"."+g):(F(":"),d(e,t+"."+g,i(!0)))}while(!F("}",!0));else d(e,t,i(!0))}function d(e,t,r){e.setOption&&e.setOption(t,r)}function R(e){if(F("[",!0)){do{w(e,"option")}while(F(",",!0));F("]")}return e}t instanceof Root||(r=t,t=new Root),r||(r=parse.defaults);for(var v,b,y,k,g,q=tokenize(e),N=q.next,x=q.push,A=q.peek,F=q.skip,z=q.cmnt,$=!0,I=!1,C=t,E=r.keepCase?function(e){return e}:camelCase;null!==(g=N());)switch(g){case"package":if(!$)throw n(g);f();break;case"import":if(!$)throw n(g);u();break;case"syntax":if(!$)throw n(g);c();break;case"option":if(!$)throw n(g);w(C,g),F(";");break;default:if(p(C,g)){$=!1;continue}throw n(g)}return parse.filename=null,{package:v,imports:b,weakImports:y,syntax:k,root:t}}module.exports=parse,parse.filename=null,parse.defaults={keepCase:!1};var tokenize=require("./tokenize"),Root=require("./root"),Type=require("./type"),Field=require("./field"),MapField=require("./mapfield"),OneOf=require("./oneof"),Enum=require("./enum"),Service=require("./service"),Method=require("./method"),types=require("./types"),util=require("./util"),base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)+$/,fqTypeRefRe=/^(?:\.[a-zA-Z][a-zA-Z_0-9]*)+$/,camelCaseRe=/_([a-z])/g;