"use strict";var path=require("path"),fs=require("fs"),gitSemverTags=require("git-semver-tags"),gitRawCommits=require("git-raw-commits"),minimist=require("minimist"),basedir=path.join(__dirname,".."),pkg=require(basedir+"/package.json"),argv=minimist(process.argv,{alias:{tag:"t",write:"w"},string:["tag"],boolean:["write"],default:{tag:null,write:!1}}),validCategories={Breaking:null,Fixed:/fix|properly|prevent|correctly/i,New:/added|initial/i,CLI:/pbjs|pbts|CLI/,Docs:/README/i,Other:null},breakingFallback=/removed|stripped|dropped/i,repo="https://github.com/dcodeIO/protobuf.js";gitSemverTags(function(e,r){if(e)throw e;var t={};Object.keys(validCategories).forEach(function(e){t[e]=[]});var i,a=[],s=r[0],n="HEAD";if(argv.tag){var o=r.indexOf(argv.tag);if(o<0)throw Error("no such tag: "+argv.tag);s=r[o+1],i=n=r[o]}else i=pkg.version;var g=gitRawCommits({from:s,to:n,merges:!1,format:"%B%n#%H"});g.on("error",function(e){throw e}),g.on("data",function(e){var r,i=e.toString("utf8").trim(),a=/#([0-9a-f]{40})$/.exec(i);a&&(i=i.substring(0,i.length-a[1].length).trim(),r=a[1]),i.split(";").forEach(function(e){if(!/^(Merge pull request |Post-merge)/.test(e)){var i,a=/^(\w+):/i.exec(e=e.trim());if(a&&a[1]in validCategories)i=a[1],e=e.substring(a[1].length+1).trim();else{for(var s=Object.keys(validCategories),n=0;n<s.length;++n){var o=validCategories[s[n]];if(o&&o.test(e)){i=s[n];break}}e=e.replace(/^(\w+):/i,"").trim()}i||(i=breakingFallback.test(e)?"Breaking":"Other");var g=e.indexOf("\n");g>-1&&(e=e.substring(0,g).trim()),!r||e.length<12||(e=e.replace(/\[ci skip\]/,"").trim(),t[i].push({text:e,hash:r}))}})}),g.on("end",function(){a.push("# ["+i+"]("+repo+"/releases/tag/"+i+")\n"),Object.keys(t).forEach(function(e){var r=t[e];r.length&&(a.push("\n## "+e+"\n"),r.forEach(function(e){var r=e.text.replace(/#(\d+)/g,"[#$1]("+repo+"/issues/$1)");a.push("[:hash:]("+repo+"/commit/"+e.hash+") "+r+"<br />\n")}))});var e;try{e=fs.readFileSync(basedir+"/CHANGELOG.md").toString("utf8")}catch(r){e=""}if(new RegExp("^# \\["+i+"\\]").test(e)){var r=e.indexOf("# [",1);e=r>-1?e.substring(r).trim():""}var s=a.join("")+"\n"+e;argv.write?fs.writeFileSync(basedir+"/CHANGELOG.md",s,"utf8"):process.stdout.write(s)})});